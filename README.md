IndieAuth Client
================

This is a simple library to help with IndieAuth. There are two ways you may want to use it, either when developing an application that signs people in using IndieAuth, or when developing your own endpoint for issuing access tokens and you need to verify auth codes.

Usage for Clients
-----------------




Usage for Token Endpoints
-------------------------

When issuing access tokens, you will need to verify the authorization code present in the request. In order to verify the authorization code, you'll first need to discover the user's auth server.

### Discovering the authorization endpoint

Requests to your token endpoint will contain the following parameters:
* me
* code
* client_id
* redirect_uri
* state

You will need to verify the code with the user's authorization server, and then create an access token for them.

First, discover the user's authorization server by looking for a `rel="authorization_server"` link on their home page.

```php
$authorizationEndpoint = IndieAuth\Client::discoverAuthorizationEndpoint($_POST['me']);
```

If discovery is successful, $authorizationEndpoint will be the full URL, such as `https://indieauth.com/auth`. Now you need to verify the auth code with the auth server. To do this, you'll need to pass in all the parameters that were part of generating the auth code, including the redirect_uri, state and client_id.

### Verifying the authorization code

```php
$auth = IndieAuth\Client::verifyIndieAuthCode($authorizationEndpoint, $_POST['code'], $_POST['me'], $_POST['redirect_uri'], $_POST['client_id'], $_POST['state']);
```

The response from the authorization server will be a form-encoded response containing the `me` parameter and more importantly, the `scope` parameter which is the list of scopes that was part of the authorization request.

```
me=http%3A%2F%2Faaronparecki.com&scope=post
```

If there was an error, the authorization server will return an HTTP 400 response with `error=invalid_request` and the `error_description` property indicating what went wrong. Errors may include:

* Missing 'code' parameter - the request did not include the "code" parameter
* Invalid code provided - could be because the code was not created at this authorization server, or just a bad code was provided
* The auth code has expired - Authorization codes are only valid for a short time
* The 'redirect_uri' parameter did not match
* The 'state' parameter did not match

The error messages are meant to be read by developers, not by end users. Your token endpoint can pass this error through for debugging purposes, or you can return your own error.

### Issuing an access token

Assuming you get a successful response from the auth server containing the "me" and "scope" parameters, you can now generate an access token and send the reply.

The way you build an access token is entirely up to you. You may want to store tokens in a database, or you may want to use self-encoded tokens to avoid the need for a database. In either case, you must store at least the "me," "scope" and "client_id" values.

The example below generates a self-encoded token by encrypting all the needed information into a string and returning the encrypted string. This example uses a [https://github.com/firebase/php-jwt JWT] library to encrypt the token, but you could use any method of encryption you wish.

```php
  // $auth is set from the IndieAuth\Client::verifyIndieAuthCode call from before

  $token_data = array(
    'date_issued' => date('Y-m-d H:i:s'),
    'me' => $auth['me'],
    'client_id' => $_POST['client_id'],
    'scope' => array_key_exists('scope', $auth) ? $auth['scope'] : '',
    'nonce' => mt_rand(1000000,pow(2,31))   // add some noise to the encrypted version
  );

  // Encrypt the token with your server-side encryption key
  $token = JWT::encode($token_data, $encryptionKey);

  header('Content-type: application/x-www-form-urlencoded');  
  echo http_build_query(array(
    'me' => $auth['me'],
    'scope' => $token_data['scope'],
    'access_token' => $token
  ));
```

Note that you must return the parameters "me", "scope" and "access_token" in your response. This is because API clients will not know the user or scope of the token otherwise, and clients will need to discover the API endpoint using the "me" parameter before they can make API requests.

### Verifying access tokens

Verifying access tokens is not actually part of this library, since the token was generated by your own server. You will need to verify tokens using whatever method you wish.

For example, your API endpoint to create new posts may wish to require a "post" scope, so you would need to verify that the access token is valid and also contains the needed scope value.

The example below illustrates how to verify the self-encoded token we created above.

```php
// Verifies an access token, returning the token on success, or responding with an HTTP 400 error on failure
function requireAccessToken($requiredScope=false) {

  if(array_key_exists('HTTP_AUTHORIZATION', $_SERVER) 
     && preg_match('/Bearer (.+)/', $_SERVER['HTTP_AUTHORIZATION'], $match)) {

    // Decode the token using the encryption key
    $token = JWT::decode($match[1], $encryptionKey);

    if($token) {
      // This is where you could add additional validations on specific client_ids. For example
      // to revoke all tokens generated by app 'http://example.com', do something like this:
      // if($token->client_id == 'http://example.com' && strtotime($token->date) <= strtotime('2013-12-21')) // revoked

      // Verify the token has the required scope
      if($requiredScope) {
        if(property_exists($token, 'scope') && in_array($requiredScope, explode(' ', $token->scope))) {
          return $token;
        } else {
          header('HTTP/1.1 401 Unauthorized');
          header('Content-type: application/x-www-form-urlencoded');
          echo http_build_query(array(
            'error' => 'invalid_scope',
            'error_description' => 'The token provided does not have the necessary scope'
          ));
          die();
        }
      } else {
        return $token;
      }
    }
  }

  header('HTTP/1.1 401 Unauthorized');
  header('Content-type: application/x-www-form-urlencoded');
  echo http_build_query(array(
    'error' => 'unauthorized',
    'error_description' => 'An access token is required. Send an HTTP Authorization header such as \'Authorization: Bearer xxxxxx\''
  ));
  die();
}
```



License
-------

Copyright 2013 by Aaron Parecki

Available under the Apache 2.0 License. See LICENSE.txt

